## 平滑的 "Phong" 阴影

改变三角形表面颜色的一种简单方法是在三角形顶点定义的法向量之间进行插值。这被称为 [Phong 着色](https://en.wikipedia.org/wiki/Phong_shading:)，以其创建者 Bui Tuong Phong 的名字命名。

本课介绍如何使用 Phong 着色来使三角形模拟曲面。

### 表面法线向量

三角形定义了位于平面中的表面。三角形平面上有无数个向量，但垂直于三角形平面的向量只有两个。按照惯例，其中一个向量定义三角形的“正面”，另一个向量定义三角形的“背面”。这些被称为三角形的“正面”和“背面”。如果向量 n 定义“正面”，则 -n 定义“背面”。

<center>
  <img src="/10/normal_vector.png" />
  <p>三角形/平面着色的法线向量</p>
</center>

如果我们为整个三角形存储一个单一的法向量，并且该向量用于组成三角形的每个片段的光反射计算，那么整个三角形将具有相同的颜色。我们将此称为“平面阴影”。

如果我们为三角形的每个顶点存储不同的法向量，那么每个片段的法向量可以是整个三角形表面的插值向量。由于光反射计算基于表面法线方向，因此每个片段都可能分配有不同的颜色。我们正在模拟一个曲面，如右图中的橙色虚线所示。

<center>
  <img src="/10/intermediate_normal_vectors.png" />
  <p>中间法线向量</p>
</center>

术语 "法向量 "可能令人困惑，因为我们现在定义的是一个不垂直于三角形平面的方向的向量。你可能会认为我们会把这个向量称为其他的东西，比如 "光反射参考向量"，但我们并没有。表面法向量定义的是光在表面上的反射情况，不管它是否垂直于三角形的平面。

我们在第 7.6 课中讨论了插值。请记住，插值是使用参数方程执行的。假设我们有两个法向量，n1 和 n2。您可以通过在 0.0 和 1.0 之间改变参数参数 t 来计算中间向量，如下所示：
```js
n = (1 - t) * n1 + t * n2  // 0.0 <= t <= 1.0
```

由于向量有3个分量，\<dx,dy,dz>，这个方程实际上代表三个方程。

- ndx = (1-t) * n1dx + t * n2dx
- ndy = (1-t) * n1dy + t * n2dy
- ndz = (1-t) * n1dz + t * n2dz

你不需要实现这些方程；WebGL图形管道会自动插值存储在不同变量中的向量。但是你必须了解插值的工作原理，因为插值修改了中间向量的大小，它们不再是正常的，即使原来的向量是正常的。图中的插值例子说明了这一点。当你在片段着色器中使用插值的法线向量时，你必须先将其归一化。

<center>
  <img src="/10/interpolated_normal_vectors.png" />
  <p>插值法向量</p>
</center>

### 计算平滑法向量

通过将顶点的法线向量设置为使用该顶点的三角形的面法线向量的平均值来实现模型的相邻三角形之间的平滑着色。例如，在右图中，一个顶点被五个三角形使用，因此中心顶点的法向量设置为来自相邻三角形的五个法向量的平均值。您可以像计算任何平均值一样计算平均法线向量：对于向量的每个分量，\<dx,dy,dz>，将每个分量相加并除以向量的数量。生成的向量将指向正确的方向以模拟相邻三角形之间的平滑过渡，但不一定会被归一化。因此，应该对其进行标准化。

<center>
  <img src="/10/average_normals.png" />
  <p>平均法线向量</p>
</center>

如果您的模型包含共享顶点并位于同一平面上的三角形，情况会变得更加复杂。考虑一个简单的立方体，如右图所示的线框模式。它由 6 个边组成，由 12 个三角形（每边两个三角形）定义。在图中，您可以看到红点处的顶点是 4 个三角形的一部分，但只有 3 个立方体面。如果取共享顶点的 4 个三角形的法线向量的平均值，则法线向量将偏向具有 2 个使用该顶点的三角形的右侧。因此，当您收集人脸法向量来计算平均值时，您必须测试人脸法向量以确保它们是唯一的。如果您发现多个相同的法向量，那么您假设它们都定义了相同的表面平面，并且您只在平均计算中包括其中一个。

<center>
  <img src="/10/duplicate_normals.png" />
  <p>重复法线向量</p>
</center>

如果为模型的面启用“平滑模式”，文件 learn_webgl_obj_to_arrays.js 中的 JavaScript 类 createModelsFromOBJ 会为模型的每个顶点计算“平滑法线向量”。如果您希望模型的法线向量平滑，请确保 OBJ 文件中的面定义上方有一行启用“平滑模式”。启用“平滑模式”的“开关”看起来像打开了。例如，

``` js
s on
f 9//1 8//1 23//1 24//1
f 2//2 1//2 16//2 17//2
...
```
