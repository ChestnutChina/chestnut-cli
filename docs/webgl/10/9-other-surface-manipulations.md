## 其他曲面操作

让我们回顾一下到目前为止我们所涵盖的内容。

- 您渲染由三角形组成的模型。
- 三角形的每个顶点都由顶点着色器转换为
    - 它在场景中的所需位置和方向（通过其模型矩阵变换），
    - 它在相机前面的所需位置和方向（通过其视图矩阵变换），以及
    - 它在 2D 屏幕上的位置（通过其投影矩阵变换）。
- 在 2D 查看窗口（即帧缓冲区）中变换的顶点内的每个片段（像素）都由片段着色器分配颜色。

片段着色器具有获取与单个片段（像素）相关的数据的基本方法：

- 顶点着色器将数据放入可变变量中，片段着色器获取该值的插值副本。
- 片段着色器对存储在图像中的值进行“表查找”。 （这是图像纹理映射。）
- 片段着色器对输入执行计算以产生输出值。 （这是程序纹理映射。）

这三种技术可以单独使用，也可以任意组合使用。这些技术可用于获取片段的颜色，或获取可用于计算片段颜色的数据。在我们知道片段的颜色后，我们通常会应用光照计算来根据它接收到的光量来修改颜色。如果我们改变这些计算中使用的数据，我们可以创造出有趣的视觉效果。但是，请记住片段着色器正在为特定片段分配颜色。 GPU 与其他片段着色器并行执行片段着色器。片段着色器不能使用来自其周围片段的信息，也不能读取或写入颜色到帧缓冲区的任何其他片段。这为片段着色器提供了速度，但限制了它的功能。

以下技术是用于赋予曲面更多细节的常用方法。请注意，每种技术的名称中都有“map”。这告诉您每个人都使用图像来存储可以应用于整个表面的值。

### 高度图/位移图

[高度图](https://en.wikipedia.org/wiki/Heightmap)是用于改变表面高度的灰度图像。如果您在 X-Z 平面中定义了一个曲面，则图像中的值将指定 Y 坐标。通常假设图像值是某个指定最大高度的百分比。图像中的像素通常存储为 RGB（红、绿、蓝）值，灰度颜色具有等量的红、绿和蓝。因此，高度的分辨率取决于用于表示像素分量值的位数。每个组件八位是常见的位深度，因此典型的灰度图像允许 256 (28) 个可能的高度值。

高度图可以以两种不同的方式使用。如果您有一个被细分为四边形（4 边多边形）的平面，则顶点着色器可以使用高度图中的值更改每个顶点的“高度”。如果您的模型的面没有细分，那么您可以实现预处理功能来细分面并使用高度图中的值作为“高度”值。对于任何任意表面，我们通常会采用“高度”来表示表面法线方向上的距离。

高度贴图的一个变体是[置换贴图](https://en.wikipedia.org/wiki/Displacement_mapping)，它改变顶点沿其法线向量的位置。置换贴图可用于顶点着色器，以在渲染模型时修改模型的几何形状。置换贴图图像包含介于 0.0（黑色）和 1.0（白色）之间的灰度值。假设您定义了最大位移，这些可以视为位移的百分比。为了允许沿着与法线向量相反方向的向量运动，可以使用 color*2.0 - 1.0 将百分比转换为范围 -1.0 和 1.0。置换贴图也可以在片段着色器中使用，以在执行光照计算之前偏移片段的位置。这不会改变最终图像中的片段位置，但它可以改变分配给片段的颜色并给出粗糙表面的错觉。

<center>
  <img src="/10/height_map_example2.png" />
  <p>
    <a href="https://www.ssucet.org/~jhudson/15/2802/heightmap/#slide-3" target="_blank">示例高度图</a>
  </p>
</center>

### 凹凸贴图/法线贴图

[凹凸贴图](https://en.wikipedia.org/wiki/Bump_mapping)通过基于凹凸贴图图像更改片段法线向量的方向来模拟表面上的凹凸。更改法线向量会更改在片段位置从表面反射的漫反射光和镜面反射光的百分比。

总体思路是这样的：

- 三角形的每个顶点都有一个法向量。顶点着色器将法线向量放入一个可变变量中，每个片段都得到一个插值法线向量。
- 片段着色器在凹凸贴图图像上查找片段在凹凸贴图中位置的四个周围像素。通过计算水平和垂直方向上的值之间的差异，您可以获得该位置周围的相对变化量。 （在数学上，这被称为“有限差分”方法。）该图显示了图像的放大区域中的 9 个像素，其中水平像素之间的差异为 7 (134-127)，垂直像素之间的差异为 12 ( 101-89)。这给了我们一个扰动向量来修改表面法线向量。在图表的示例中，扰动向量为 \<7,12>。
- 表面法线向量由凹凸贴图计算的有限差分修改。
- 使用新的法线向量执行漫反射和镜面反射计算。

扰动向量需要与法线向量正交才能执行准确的凹凸映射，但我们将省略这些细节。凹凸贴图的基本思想是修改表面法线，以便光照计算模拟不规则表面。

您可以将[法线贴图](https://en.wikipedia.org/wiki/Normal_mapping)视为凹凸贴图的变体。法线贴图中的值不用于修改法线向量——它们是法线向量！法线贴图图像中像素的 RGB 值用作表面上该点的表面法线的 \<dx,dy,dz> 值。法线贴图在 X-Y 平面中定义，+Z 轴是表面法线的大致方向。由于颜色 (0,0,1) 是蓝色，因此法线贴图图像的颜色往往是“蓝色”，如示例中所示。

<center>
  <img src="/10/normal_map.jpg" />
  <p>
    <a href="http://www.nmaker.com.br/tools.html" target="_blank">图像及其相关的法线贴图</a>
  </p>
</center>

因为图像中的颜色值都是介于 0.0 和 1.0 之间的正值，并且法向量可以指向任何方向，所以必须先对法向量进行变换，然后才能将它们存储到图像中。给定向量的分量值在 -1.0 到 1.0 范围内，它按 1/2 缩放，然后偏移 1/2 以使其在 0.0 到 1.0 范围内（例如，delta * 0.5 + 0.5）。从图像中提取颜色时，必须通过撤消变换将每个分量转换回法向量值，component * 2.0 - 1.0。

创建法线贴图并非易事，因此它们通常是使用软件工具创建的。 Blender 包含用于创建法线贴图并将其保存为图像的工具。术语“烘焙”通常用于此过程。该软件基本上会为特定模型创建您想要的所有法线向量，然后将它们保存以供以后使用。这样就不必重复创建法线向量的工作。

[视差贴图](https://en.wikipedia.org/wiki/Parallax_mapping)是对凹凸贴图或法线贴图的增强，它修改片段处的纹理坐标以提供更大的真实感和更多的深度错觉。