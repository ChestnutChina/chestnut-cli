## 正射投影

正射投影用于工程领域，以创建模型的精确渲染。它们保持平行线，但不提供深度感。所有顶点都被直接投射到观察窗上。从虚拟摄像机到物体的距离对渲染物体的大小没有影响。在现实生活中，离摄像机更远的物体看起来更小。

本课将介绍如何创建正投影以及其4乘4变换矩阵背后的数学原理。

### `createOrthographic()` 函数

`Learn_webgl_matrix.js`模块中的函数`createOrthographic()`创建了一个正射投影变换矩阵。该函数需要6个参数，如下面的函数原型所示。

```JavaScript
/** -----------------------------------------------------------------
 * 创建一个正交投影矩阵。
 * @param left   Number x 轴最左边
 * @param right  Number x 轴最右边
 * @param bottom Number y 轴最下方
 * @param top    Number 在 y 轴上最远
 * @param near   Number 沿 -Z 轴到近剪裁平面的距离
 * @param far    Number 沿 -Z 轴到远剪裁平面的距离
 * @return Float32Array 正交变换矩阵
 */
function createOrthographic(left, right, bottom, top, near, far)
```

这六个参数构成了一个矩形立方体，定义了渲染的可见区域。实验一下下面的例子，它允许你改变createOrthographic函数调用的参数，并在右边的第二个画布窗口中看到结果的渲染。你可以在左边的画布上点击和拖动，来修改你对虚拟世界的看法。

点击查看[交互式例子](http://learnwebgl.brown37.net/08_projections/projections_ortho.html#the-createorthographic-function)

[在新的标签或窗口中打开这个webgl程序](http://learnwebgl.brown37.net/08_projections/create_ortho/create_ortho.html)

当你尝试使用正投影参数时，请确保你观察到正投影的以下特征。

- 查看体积之外的原始元素（点、线或三角形）从视图中被剪裁掉。 （个别元素可以部分可见。）
- 有两个相同的模型，但每个模型与相机的距离不同。请注意，两个模型都呈现相同的大小。
- 请注意，模型中的平行线在渲染中是平行的。
- 如果投影的宽度和高度的纵横比与画布的宽度和高度的纵横比不同，则渲染会失真。作为程序员，确保纵横比一致是您的工作。
- 左边、右边、下面和上面的值是直观的。近和远的数值则不直观。底线是，考虑你想在渲染中包含的沿Z轴的数值范围。近将是最大的Z值，而远将是最小的值。然后把这两个值都否定掉。例如，如果你想看到z=10和z=2之间的所有东西，那么就把near=-10，far=-2；如果你想看到z=3和z=-12之间的所有东西，那么就把near=3，far=12。非常奇怪，尽管这些参数有一个模式。例如，如果你想看到原点10个单位内的所有东西，你对createOrthographic的参数将是（-10, 10, -10, 10, -10, 10）。你也可以把近和远的值看作是-Z轴上的距离，允许有负的距离。
- 如果left的值大于right的值，世界就会围绕Y轴进行镜像。如果底部的值大于顶部的值，世界就会围绕X轴镜像。如果你把近处和远处的值弄混了，深度剪裁就会倒过来。
- 观察窗是观察体的正面。它在左下角由点（左、底、近）定义，在右上角由点（右、顶、近）定义。

### 正交投影矩阵

正如我们在上一课中所讨论的，投影矩阵必须将场景中的顶点放入剪裁体积中，剪裁体积是一个2单位宽的立方体，如图所示。这很容易通过三个变换来完成:

1. 平移由createOrthographic参数定义的体积，使其以原点为中心，然后
2. 使用每个轴的适当比例系数将体积缩放为一个2单位宽的立方体，然后
3. 翻转Z轴以匹配剪裁空间的坐标系。

<center>
  <img src="/8/clipping_volume.png" />
</center>

让我们讨论每个步骤的细节。

#### 将查看体积居中于原点

让我们用一个参数方程来计算两个数值之间的中点。当t等于0.5时，就可以计算出中点。因此，左边和右边的中间点可以这样计算。

```JavaScript
mid_x = (1-0.5)*left + (0.5)*right;  // t = 0.5
```
这可以简化为左和右的简单相加除以2。
```js
mid_x = (left + right) / 2;  // t = 0.5
```

我们可以用三个这样的方程来计算观察体的中心。我们否定近处和远处的数值，使其成为右手坐标系的数值。
```js
mid_x = (left + right) / 2;
mid_y = (bottom + up) / 2;
mid_z = (-near + -far) / 2;
```

因此，我们可以通过这个变换矩阵来平移观察体，使其以全局原点为中心:

```html
                    ┌               ┐ Eq1
centerAboutOrigin = │ 1 0 0  -mid_x │ 
                    | 0 1 0  _mid_y |
                    | 0 0 1  _mid_z |
                    | 0 0 0       1 |
                    └               ┘
```

#### 缩放观看量

缩放需要一个简单的比率。如果查看体积的当前宽度为 10 个单位宽，则将值缩放到 2 个单位宽需要 2/10 或 1/5 的比例因子。我们的比例因子必须是：
```js
scale_x = 2.0 / (right - left);
scale_y = 2.0 / (up - bottom);
scale_z = 2.0 / (far - near);
```
我们的缩放变换如下所示：

```html
                      ┌                            ┐ Eq2
scaleViewingVolume  = │ scale_x 0       0        0 │ 
                      | 0       scale_y 0        0 |
                      | 0       0       scale_z  0 |
                      | 0       0       0        1 |
                      └                            ┘
```

#### 切换坐标系

右手坐标系和左手坐标系的唯一区别是Z轴的方向。顶点可以通过Z分量乘以-1在两个系统之间进行切换。下面是我们的坐标系互换的变换:

```html
                      ┌          ┐ Eq3
convertToLeftHanded = │ 1 0  0 0 │ 
                      | 0 1  0 0 |
                      | 0 0 -1 0 |
                      | 0 0  0 1 |
                      └          ┘
```

#### 正交投影变换

从概念上讲，正交变换由这三个从右到左应用的顺序变换组成：

```html
┌          ┐   ┌                            ┐   ┌               ┐   ┌   ┐   ┌    ┐ Eq4
│ 1 0  0 0 │   │ scale_x 0       0        0 │   │ 1 0 0  -mid_x │   | x |   | x' |
| 0 1  0 0 | * | 0       scale_y 0        0 | * | 0 1 0  _mid_y | * | y | = | y' |
| 0 0 -1 0 |   | 0       0       scale_z  0 |   | 0 0 1  _mid_z |   | z |   | z' |
| 0 0  0 1 |   | 0       0       0        1 |   | 0 0 0       1 |   | w |   | w' |
└          ┘   └                            ┘   └               ┘   └   ┘   └    ┘
```

如果你简化这些条款，你会得到这样的转变。

```html
┌                                                                         ┐ Eq5
│ 2/(right-left) 0               0             -(right+left)/(right-left) │ 
| 0              2/(top-bottom)  0             -(top+bottom)/(top-bottom) |
| 0              0               -2/(far-near) -(far+near)/(far-near)     |
| 0              0               0             1                          |
└                                                                         ┘
```

### 总结

当你把正射投影分解成其基本组成部分时，就非常容易理解数学是如何完成所需的操作的。如果你想理解复杂的变换，就把它们分解成基本的步骤。

正投影不会修改顶点的（x,y）值之间的相对关系，因此物体的大小不会因为它离摄像机更近或更远而改变。正投影为剪裁顶点做了准备。